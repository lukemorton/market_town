<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: INTRODUCTION
  
    &mdash; MarketTown::Checkout
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "INTRODUCTION";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: INTRODUCTION</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="file_list.html"></iframe>

      <div id="content"><div id='filecontents'>
<h1 id="label-Introduction+to+implementing+a+checkout">Introduction to implementing a checkout</h1>

<p>This library provides logic for common steps in a checkout. You can use
these steps in your checkout controllers. This example will be in Ruby on
Rails but it could be any ruby framework or library, even Rack.</p>

<h2 id="label-Dependency+container">Dependency container</h2>

<p>First of all let&#39;s create a dependency container for an imaginary
e-commerce framework.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AppContainer</span> <span class='op'>&lt;</span> <span class='const'>MarketTown</span><span class='op'>::</span><span class='const'>Checkout</span><span class='op'>::</span><span class='const'>Dependencies</span>
  <span class='kw'>class</span> <span class='const'>Fulfilments</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_can_fulfil_address?'>can_fulfil_address?</span><span class='lparen'>(</span><span class='id identifier rubyid_delivery_address'>delivery_address</span><span class='rparen'>)</span>
      <span class='const'>Ecom</span><span class='op'>::</span><span class='const'>DistributionService</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_check_address'>check_address</span><span class='lparen'>(</span><span class='id identifier rubyid_delivery_address'>delivery_address</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_propose_shipments'>propose_shipments</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_shipments'>shipments</span> <span class='op'>&lt;&lt;</span> <span class='const'>Ecom</span><span class='op'>::</span><span class='const'>Shipments</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_propose'>propose</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:delivery_address</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>class</span> <span class='const'>AddressStorage</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:address_type</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='symbol'>:delivery</span>
        <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_shipment_addresses'>shipment_addresses</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:delivery_address</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='symbol'>:billing</span>
        <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_billing_addresses'>billing_addresses</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:billing_address</span><span class='rbracket'>]</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>class</span> <span class='const'>Finish</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_address_step'>address_step</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_state'>state</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_update!'>update!</span><span class='lparen'>(</span><span class='label'>step:</span> <span class='symbol'>:delivery</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_fulfilments'>fulfilments</span>
    <span class='const'>Fulfilments</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_address_storage'>address_storage</span>
    <span class='const'>AddressStorage</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_finish'>finish</span>
    <span class='const'>Finish</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Inside this container we wrote some simple adapters to our e-commerce
framework. You can of course keep these adapters in another file, we&#39;ve
kept them here to keep the example simple. The container exposes the
adapters via methods that are used by MarketTown::Checkout steps.</p>

<h2 id="label-Generic+step+controller">Generic step controller</h2>

<p>Now we can implement our base step controller:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>StepController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_edit'>edit</span>
    <span class='ivar'>@order</span> <span class='op'>=</span> <span class='const'>Ecom</span><span class='op'>::</span><span class='const'>Order</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>user:</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
    <span class='ivar'>@order</span> <span class='op'>=</span> <span class='const'>Ecom</span><span class='op'>::</span><span class='const'>Order</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>user:</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_process_step'>process_step</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_checkout_path'>checkout_path</span><span class='lparen'>(</span><span class='ivar'>@order</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>MarketTown</span><span class='op'>::</span><span class='const'>Checkout</span><span class='op'>::</span><span class='const'>Error</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_flash'>flash</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='lbracket'>[</span><span class='symbol'>:errors</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:edit</span>
  <span class='kw'>rescue</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>RecordInvalid</span>
    <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:edit</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_process_step'>process_step</span>
    <span class='const'>MarketTown</span><span class='op'>::</span><span class='const'>Checkout</span><span class='period'>.</span><span class='id identifier rubyid_process_step'>process_step</span><span class='lparen'>(</span><span class='label'>step:</span> <span class='id identifier rubyid_step_name'>step_name</span><span class='comma'>,</span>
                                      <span class='label'>dependencies:</span> <span class='const'>AppContainer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span>
                                      <span class='label'>state:</span> <span class='id identifier rubyid_step_state'>step_state</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_step_state'>step_state</span>
    <span class='lbrace'>{</span> <span class='label'>user:</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span>
      <span class='label'>order:</span> <span class='ivar'>@order</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h2 id="label-Address+step+controller">Address step controller</h2>

<p>And now let&#39;s create our address checkout step:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AddressStepController</span> <span class='op'>&lt;</span> <span class='const'>StepController</span>
  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_step_name'>step_name</span>
    <span class='symbol'>:address</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_step_state'>step_state</span>
    <span class='id identifier rubyid_address_params'>address_params</span> <span class='op'>=</span> <span class='qsymbols_beg'>%i(</span><span class='tstring_content'>name</span><span class='words_sep'> </span><span class='tstring_content'>address_1</span><span class='words_sep'> </span><span class='tstring_content'>locality</span><span class='words_sep'> </span><span class='tstring_content'>postal_code</span><span class='words_sep'> </span><span class='tstring_content'>country</span><span class='words_sep'> </span><span class='tstring_content'>save</span><span class='words_sep'>)</span>

    <span class='kw'>super</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_require'>require</span><span class='lparen'>(</span><span class='symbol'>:order</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_permit'>permit</span><span class='lparen'>(</span><span class='label'>billing_address:</span> <span class='id identifier rubyid_address_params'>address_params</span><span class='comma'>,</span>
                                              <span class='label'>delivery_address:</span> <span class='id identifier rubyid_address_params'>address_params</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>You could create a controller for each step in the same way.</p>
</div></div>

      <div id="footer">
  Generated on Sat Apr 30 20:02:21 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.3.0).
</div>

    </div>
  </body>
</html>